# 
### 用户模块功能实现开发思路

**1. 注册与初始化**

*   **用户角色区分**:
*   在 <mcfile name="数据库设计.md" path="e:\Learn_zone\Mark_down\Ob_Responsity\金蝶云苍穹开发\hello\数据库设计.md"></mcfile> 的 `user` 表中通过 `account_type` 字段（ENUM('学生','教师')）区分用户角色。
*   **学生注册流程**:
1.  **前端交互**: 提供学生注册入口，用户选择“学生”身份，填写学号和教务系统密码。
2.  **后端验证**: 调用（需外部提供或模拟的）教务系统接口验证学籍信息。
3.  **数据存储**: 验证通过后，在 `user` 表创建记录，`account_type` 设为 '学生'，`student_id/staff_id` 记录学号。同时，在 `student_profile` 表创建关联记录，`student_id` 关联 `user.user_id`，`status` 根据验证结果设置（如 '待验证' 或 '已通过'）。
4.  **安全信息**: 引导用户设置手机号和邮箱，使用AES-256加密后存入 `user` 表的 `phone` 和 `email` 字段。密码使用 bcrypt 哈希后存入 `password_hash`。
5.  **时间记录**: `register_time` 记录当前时间。
6.  **信息关联**: 根据学号自动关联班级/专业信息，更新 `student_profile` 表的 `major_id` 和 `class_id`（需确保 `class` 和 `major` 表存在并正确设置外键）。
*   **教师注册流程**:
1.  **前端交互**: 提供教师注册入口，用户选择“教师”身份，填写工号和人事系统验证信息。
2.  **后端验证**: 调用（需外部提供或模拟的）人事系统接口验证教职工信息。
3.  **数据存储**: 验证通过后，在 `user` 表创建记录，`account_type` 设为 '教师'，`student_id/staff_id` 记录工号。同时，在 `teacher_profile` 表创建关联记录，`teacher_id` 关联 `user.user_id`。
4.  **安全信息**: 同学生注册流程。
5.  **时间记录**: `register_time` 记录当前时间。
6.  **权限与偏好**: 教师账号触发课程权限初始化，允许关联任教课程（ID存入 `teacher_profile.teaching_courses` JSON数组），并根据关联课程在 `user_role` 表分配「课程所有者」角色。引导设置教学偏好，存入 `teacher_profile.preferences` JSON对象。

**2. 登录与身份认证**

*   **标准登录**:
1.  **前端交互**: 用户输入学号/工号和密码。
2.  **后端验证**: 查询 `user` 表获取 `password_hash`，使用 bcrypt 比较密码。可集成短信验证码二次验证。
3.  **状态更新**: 验证成功后，更新 `last_login_time`，并检查 `account_status`。
*   **快速认证**:
1.  **系统对接**: 对接校园统一身份认证系统（如OAuth 2.0/SAML）。
2.  **信息同步**: 认证成功后，根据返回信息在 `user` 表查找或引导注册，并更新 `last_login_time`。
*   **安全机制**:
*   密码 bcrypt 哈希存储。
*   姓名、手机、邮箱 AES-256 加密存储。
*   登录失败次数限制与账户锁定（可在 `user` 表增加 `failed_login_attempts`, `lockout_until` 字段）。
*   Session管理与JWT机制。

**3. 权限管理**

*   **权限定义 (`permission` 表)**: 定义各项操作权限，如 `code`（'course_owner'）, `level`（'课程级'）, `description`。
*   **角色定义 (`role` 表)**: 定义用户角色（如“学生”, “教师”, “课程所有者”），支持 `parent_role_id` 实现继承。
*   **角色-权限关联 (`role_permission` 表)**: 为角色分配具体权限。
*   **用户-角色关联 (`user_role` 表)**: 为用户赋予角色。
*   **动态权限分配**:
*   **课程相关**: 教师创建课程时，自动在 `user_role` 表（或更细粒度的 `user_course_role` 表，包含 `user_id`, `course_id`, `role_id`）赋予其对该课程的「课程所有者」角色。可参考 <mcfile name="数据库设计.md" path="e:\Learn_zone\Mark_down\Ob_Responsity\金蝶云苍穹开发\hello\数据库设计.md"></mcfile> 中提到的 `user_course_access` 表进行设计。
*   **社群权限**: 根据社群模块设计，在用户加入或创建社群时分配相应角色和权限。

**4. 学生专属流程**

*   **资源下载**:
1.  **权限校验**: 检查用户是否有权访问（通过 `user_role`, `role_permission` 或 `user_course_access`）。
2.  **行为记录**: 权限通过后，在 `learning_behavior` 表记录下载行为 (`type`='资源下载'，`metadata`含资源ID）。
3.  **成就关联**: 对接成就系统。
*   **题目提交**:
1.  **行为记录**: 在 `learning_behavior` 表记录 (`type`='做题'，`metadata`含题目ID、答案等）。
2.  **教师审核**: 可能需要 `submission` 表（含 `student_id`, `question_id`, `answer`, `status` 等）供教师审核。
3.  **知识点关联**: 题目应关联 `knowledge_point` 表，用于后续分析。
*   **学业画像构建**:
*   **资源浏览记录**: 分析 `learning_behavior` 表中资源相关记录，结合资源标签为学生打兴趣标签（可能需 `user_interest_tag` 表）。
*   **错题统计**: 分析 `error_book` 表，结合 `question_knowledge_weight` 表识别薄弱知识点（可能需 `student_weak_knowledge_point` 表）。

**5. 教师专属流程**

*   **权限清单实现**:
*   **课程管理**: 创建课程（插入 `course` 表，关联 `creator_id`），编辑课程，归档课程（更新 `course.status`）。
*   **资源审核**: 审批学生上传资源（修改 `student_uploaded_resource.status`，假设有此表）。
*   **社区管理**: 管理 `post` 表内容。
*   **数据分析**: 查询 `learning_behavior`, `error_book`, `learning_report` 等表。
*   **教学看板初始化**:
*   **自动生成**: 首次登录时，统计任教课程资源（查询 `teacher_profile.teaching_courses` 及关联的资源表），生成班级学生活跃度热力图（分析 `learning_behavior`）。
*   **手动配置**: 教学进度提醒阈值、作业批改偏好等存入 `teacher_profile.preferences`。

**6. 异常处理流程**

*   关键操作日志记录。
*   数据库操作事务管理。
*   输入验证，防SQL注入。
*   用户账户冻结/解冻逻辑（更新 `user.account_status`）。

**7. 数据输出**

*   **实时输出**: 用户在线状态（可使用 `user_session` 表或Redis等缓存机制）。
*   **定期生成**: 用户增长报告、班级活跃度分析、学生学习行为简报（可存入 `learning_report` 表或动态生成）。

**关键数据库表及字段回顾 (基于您的文档):**

*   `user`: `user_id` (PK), `account_type`, `student_id/staff_id` (UK), `name` (Enc), `phone` (Enc), `email` (Enc), `password_hash`, `register_time`, `last_login_time`, `account_status`.
*   `student_profile`: `student_id` (FK to `user.user_id`, PK), `major_id` (FK), `class_id` (FK), `status`.
*   `teacher_profile`: `teacher_id` (FK to `user.user_id`, PK), `teaching_courses` (JSON), `preferences` (JSON).
*   `permission`: `permission_id` (PK), `code` (UK), `level`, `description`.
*   `role`: `role_id` (PK), `name`, `parent_role_id` (FK to `role.role_id`).
*   `user_role`: `user_id` (FK), `role_id` (FK) - (Composite PK).
*   `role_permission`: `role_id` (FK), `permission_id` (FK) - (Composite PK).
*   `learning_behavior`: `user_id` (FK), `timestamp`, `type`, `metadata` (JSON) - (Composite PK: `user_id`, `timestamp`).
*   `error_book`: `student_id` (FK to `user.user_id`), `question_id` (FK), `error_tags` (JSON), `last_wrong_time` - (Composite PK: `student_id`, `question_id`).

**待进一步明确的设计点:**

*   班级表 (`class`) 和专业表 (`major`) 的具体结构。
*   课程资源表 (`course_resource`) 和学生上传资源表 (`student_uploaded_resource`) 的详细设计。
*   题目表 (`question`) 的结构。
*   校园统一身份认证系统、短信服务的具体对接细节。
*   `user_course_access` 表与 `user_role` 表在课程权限管理中的具体分工与协作方式。

希望这份详细的开发思路对您有所帮助！如果您有任何其他问题或需要进一步细化某个部分，请随时告诉我。
当前模型请求量过大，请求排队约 1 位，请稍候或切换至其他模型问答体验更流畅。