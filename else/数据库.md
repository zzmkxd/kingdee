# 数据库设计文档 (重构版)

## 1. 设计原则

*   **模块化**：各功能模块数据独立，通过清晰定义的关联关系进行交互。
*   **规范性**：遵循统一的命名规范、数据类型标准和约束定义。
*   **扩展性**：设计时考虑未来功能的扩展，预留必要字段或采用灵活结构。
*   **性能**：合理设计索引，优化查询密集型操作。
*   **安全性**：结合业务需求，考虑数据权限隔离和敏感信息保护。
*   **一致性**：确保关联数据的一致性和完整性。

## 2. 命名规范

*   **表名**：小写下划线命名法 (e.g., `user_accounts`, `course_info`)。前缀可用于区分模块 (e.g., `usr_` 用户, `edu_` 教务, `res_` 资源, `srv_` 服务, `soc_` 社区, `ana_` 分析)。
*   **字段名**：小写下划线命名法 (e.g., `user_id`, `created_at`)。
*   **主键**：统一使用 `id` 作为自增主键，或使用有业务含义的唯一标识符 (e.g., `user_uuid`)。
*   **外键**：`[关联表名]_id` (e.g., `user_id` 作为 `course_enrollments` 表中关联 `users` 表的外键)。
*   **索引名**：`idx_[表名]_[字段名]` 或 `uk_[表名]_[字段名]` (唯一索引)。
*   **布尔类型字段**：以 `is_` 或 `has_` 开头 (e.g., `is_active`, `has_attachment`)。

## 3. 通用字段

以下字段建议在多数表中包含，用于审计和管理：

*   `id` (BIGINT UNSIGNED / UUID, PK, Not Null, Auto Increment / Generated): 主键。
*   `created_at` (DATETIME, Not Null, Default CURRENT_TIMESTAMP): 创建时间。
*   `updated_at` (DATETIME, Not Null, Default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 最后更新时间。
*   `deleted_at` (DATETIME, Nullable): 软删除标记，为NULL表示未删除。
*   `created_by` (VARCHAR(255), Nullable): 创建者标识。
*   `updated_by` (VARCHAR(255), Nullable): 更新者标识。
*   `version` (INT UNSIGNED, Not Null, Default 1): 乐观锁版本号。
*   `remark` (TEXT, Nullable): 备注。

## 4. 模块划分与表设计

### 4.1 用户管理模块 (usr_)

#### 4.1.1 用户表 (`usr_users`)

| 字段名                   | 类型                                                           | 约束/索引                                    | 说明                            |
| --------------------- | ------------------------------------------------------------ | ---------------------------------------- | ----------------------------- |
| `id`                  | BIGINT UNSIGNED                                              | PK, AI                                   | 用户唯一ID                        |
| `user_uuid`           | VARCHAR(36)                                                  | UK, Not Null                             | 用户全局唯一标识符 (UUID)              |
| `username`            | VARCHAR(100)                                                 | UK, Not Null                             | 用户名 (登录使用)                    |
| `password_hash`       | VARCHAR(255)                                                 | Not Null                                 | 加密后的密码                        |
| `email`               | VARCHAR(255)                                                 | UK, Nullable                             | 电子邮箱                          |
| `phone_number`        | VARCHAR(20)                                                  | UK, Nullable                             | 手机号码                          |
| `nickname`            | VARCHAR(100)                                                 | Nullable                                 | 昵称                            |
| `avatar_url`          | VARCHAR(512)                                                 | Nullable                                 | 头像URL                         |
| `real_name`           | VARCHAR(100)                                                 | Nullable                                 | 真实姓名                          |
| `student_id`          | VARCHAR(50)                                                  | UK (if applicable), Nullable             | 学号 (学生特有)                     |
| `teacher_id`          | VARCHAR(50)                                                  | UK (if applicable), Nullable             | 教工号 (教师特有)                    |
| `user_type`           | ENUM('student', 'teacher', 'admin', 'guest')                 | Not Null                                 | 用户类型                          |
| `status`              | ENUM('active', 'inactive', 'pending_verification', 'banned') | Not Null, Default 'pending_verification' | 账户状态                          |
| `last_login_at`       | DATETIME                                                     | Nullable                                 | 最后登录时间                        |
| `last_login_ip`       | VARCHAR(45)                                                  | Nullable                                 | 最后登录IP                        |
| `registration_ip`     | VARCHAR(45)                                                  | Nullable                                 | 注册IP                          |
| `language_preference` | VARCHAR(10)                                                  | Nullable, Default 'zh-CN'                | 语言偏好 (e.g., 'zh-CN', 'en-US') |
| ...通用字段...            |                                                              |                                          |                               |

#### 4.1.2 角色表 (`usr_roles`)

| 字段名         | 类型            | 约束/索引      | 说明             |
| -------------- | --------------- | -------------- | ---------------- |
| `id`           | INT UNSIGNED    | PK, AI         | 角色ID           |
| `role_name`    | VARCHAR(50)     | UK, Not Null   | 角色名称 (e.g., '管理员', '学生代表') |
| `description`  | VARCHAR(255)    | Nullable       | 角色描述         |
| ...通用字段... |                 |                |                  |

#### 4.1.3 用户角色关联表 (`usr_user_roles`)

| 字段名         | 类型            | 约束/索引                      | 说明     |
| -------------- | --------------- | ------------------------------ | -------- |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Not Null    | 用户ID   |
| `role_id`      | INT UNSIGNED    | FK (usr_roles.id), Not Null    | 角色ID   |
| ...通用字段... |                 |                                |          |
|                |                 | PK (`user_id`, `role_id`)      | 联合主键 |

#### 4.1.4 权限表 (`usr_permissions`)

| 字段名            | 类型            | 约束/索引      | 说明                                     |
| ----------------- | --------------- | -------------- | ---------------------------------------- |
| `id`              | INT UNSIGNED    | PK, AI         | 权限ID                                   |
| `permission_name` | VARCHAR(100)    | UK, Not Null   | 权限名称 (e.g., 'create_course', 'view_reports') |
| `resource_type`   | VARCHAR(50)     | Not Null       | 资源类型 (e.g., 'course', 'user', 'system') |
| `action`          | VARCHAR(50)     | Not Null       | 操作 (e.g., 'create', 'read', 'update', 'delete', 'list') |
| `description`     | VARCHAR(255)    | Nullable       | 权限描述                                 |
| ...通用字段...    |                 |                |                                          |

#### 4.1.5 角色权限关联表 (`usr_role_permissions`)

| 字段名            | 类型         | 约束/索引                           | 说明     |
| ----------------- | ------------ | ----------------------------------- | -------- |
| `role_id`         | INT UNSIGNED | FK (usr_roles.id), Not Null         | 角色ID   |
| `permission_id`   | INT UNSIGNED | FK (usr_permissions.id), Not Null   | 权限ID   |
| ...通用字段...    |              |                                     |          |
|                   |              | PK (`role_id`, `permission_id`)     | 联合主键 |

#### 4.1.6 用户设置表 (`usr_user_settings`)

| 字段名         | 类型            | 约束/索引                  | 说明                                     |
| -------------- | --------------- | -------------------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                     | 设置ID                                   |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), UK, Not Null | 用户ID                                   |
| `settings_json`| JSON            | Not Null                   | 用户个性化设置 (e.g., 主题, 通知偏好)    |
| ...通用字段... |                 |                            |                                          |

### 4.2 教学资源模块 (res_)

#### 4.2.1 课程信息表 (`res_courses`)

| 字段名               | 类型                                     | 约束/索引                                    | 说明                          |
| ----------------- | -------------------------------------- | ---------------------------------------- | --------------------------- |
| `id`              | BIGINT UNSIGNED                        | PK, AI                                   | 课程ID                        |
| `course_code`     | VARCHAR(50)                            | UK, Not Null                             | 课程代码                        |
| `course_name`     | VARCHAR(255)                           | Not Null                                 | 课程名称                        |
| `description`     | TEXT                                   | Nullable                                 | 课程描述                        |
| `teacher_id`      | BIGINT UNSIGNED                        | FK (usr_users.id), Index, Not Null       | 授课教师ID (关联用户表中的教师)          |
| `credits`         | DECIMAL(3,1)                           | Nullable                                 | 学分                          |
| `department_id`   | BIGINT UNSIGNED                        | FK (res_departments.id), Index, Nullable | 开课院系ID                      |
| `category`        | VARCHAR(100)                           | Nullable                                 | 课程分类 (e.g., '专业必修', '通识选修') |
| `cover_image_url` | VARCHAR(512)                           | Nullable                                 | 课程封面图片URL                   |
| `status`          | ENUM('draft', 'published', 'archived') | Not Null, Default 'draft'                | 课程状态                        |
| ...通用字段...        |                                        |                                          |                             |

#### 4.2.2 课程章节表 (`res_course_chapters`)

| 字段名             | 类型              | 约束/索引                                | 说明       |
| --------------- | --------------- | ------------------------------------ | -------- |
| `id`            | BIGINT UNSIGNED | PK, AI                               | 章节ID     |
| `course_id`     | BIGINT UNSIGNED | FK (res_courses.id), Index, Not Null | 课程ID     |
| `chapter_title` | VARCHAR(255)    | Not Null                             | 章节标题     |
| `chapter_order` | INT UNSIGNED    | Not Null                             | 章节顺序     |
| `description`   | TEXT            | Nullable                             | 章节描述     |
| ...通用字段...      |                 |                                      |          |
|                 |                 | UK (`course_id`, `chapter_order`)    | 保证章节顺序唯一 |

#### 4.2.3 课程资源表 (`res_course_resources`)

| 字段名          | 类型            | 约束/索引                                  | 说明                                     |
| --------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`            | BIGINT UNSIGNED | PK, AI                                     | 资源ID                                   |
| `chapter_id`    | BIGINT UNSIGNED | FK (res_course_chapters.id), Index, Not Null | 所属章节ID                               |
| `resource_name` | VARCHAR(255)    | Not Null                                   | 资源名称                                 |
| `resource_type` | ENUM('video', 'document', 'link', 'quiz', 'assignment') | Not Null | 资源类型                                 |
| `resource_url`  | VARCHAR(1024)   | Nullable                                   | 资源URL (外部链接或文件存储路径)         |
| `file_path`     | VARCHAR(1024)   | Nullable                                   | 文件在服务器上的相对路径 (内部存储)      |
| `file_size`     | BIGINT UNSIGNED | Nullable                                   | 文件大小 (bytes)                         |
| `mime_type`     | VARCHAR(100)    | Nullable                                   | 文件MIME类型                             |
| `description`   | TEXT            | Nullable                                   | 资源描述                                 |
| `upload_by`     | BIGINT UNSIGNED | FK (usr_users.id), Index, Nullable         | 上传者ID                                 |
| `is_downloadable`| BOOLEAN        | Not Null, Default TRUE                     | 是否可下载                               |
| ...通用字段...  |                 |                                            |                                          |

#### 4.2.4 院系信息表 (`res_departments`)

| 字段名         | 类型            | 约束/索引      | 说明         |
| -------------- | --------------- | -------------- | ------------ |
| `id`           | BIGINT UNSIGNED | PK, AI         | 院系ID       |
| `dept_code`    | VARCHAR(50)     | UK, Not Null   | 院系代码     |
| `dept_name`    | VARCHAR(255)    | Not Null       | 院系名称     |
| `parent_dept_id`| BIGINT UNSIGNED | FK (res_departments.id), Index, Nullable | 上级院系ID (用于树形结构) |
| `description`  | TEXT            | Nullable       | 院系描述     |
| ...通用字段... |                 |                |              |

#### 4.2.5 图书信息表 (`res_books`) (参考“借书助手”案例)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 图书ID                                   |
| `isbn`         | VARCHAR(20)     | UK, Not Null   | ISBN号                                   |
| `title`        | VARCHAR(255)    | Not Null       | 书名                                     |
| `author`       | VARCHAR(255)    | Nullable       | 作者                                     |
| `publisher`    | VARCHAR(255)    | Nullable       | 出版社                                   |
| `publish_date` | DATE            | Nullable       | 出版日期                                 |
| `description`  | TEXT            | Nullable       | 内容简介                                 |
| `category_id`  | BIGINT UNSIGNED | FK (res_book_categories.id), Index, Nullable | 图书分类ID                               |
| `location`     | VARCHAR(100)    | Nullable       | 馆藏位置                                 |
| `total_stock`  | INT UNSIGNED    | Not Null, Default 0 | 总库存量                                 |
| `available_stock`| INT UNSIGNED  | Not Null, Default 0 | 可借阅库存                               |
| `cover_image_url`| VARCHAR(512)  | Nullable       | 封面图片URL                              |
| ...通用字段... |                 |                |                                          |

#### 4.2.6 图书分类表 (`res_book_categories`)

| 字段名         | 类型            | 约束/索引      | 说明         |
| -------------- | --------------- | -------------- | ------------ |
| `id`           | BIGINT UNSIGNED | PK, AI         | 分类ID       |
| `category_name`| VARCHAR(100)    | UK, Not Null   | 分类名称     |
| `parent_category_id`| BIGINT UNSIGNED | FK (res_book_categories.id), Index, Nullable | 父分类ID     |
| ...通用字段... |                 |                |              |

### 4.3 学情分析模块 (ana_)

#### 4.3.1 学生课程学习进度表 (`ana_student_course_progress`)

| 字段名            | 类型            | 约束/索引                                  | 说明                                     |
| ----------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`              | BIGINT UNSIGNED | PK, AI                                     | 进度ID                                   |
| `user_id`         | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 学生ID                                   |
| `course_id`       | BIGINT UNSIGNED | FK (res_courses.id), Index, Not Null       | 课程ID                                   |
| `last_accessed_chapter_id` | BIGINT UNSIGNED | FK (res_course_chapters.id), Index, Nullable | 最后访问章节ID                           |
| `last_accessed_resource_id`| BIGINT UNSIGNED | FK (res_course_resources.id), Index, Nullable | 最后访问资源ID                           |
| `progress_percentage` | DECIMAL(5,2)  | Not Null, Default 0.00, Min 0, Max 100   | 学习进度百分比                           |
| `completed_at`    | DATETIME        | Nullable                                   | 课程完成时间                             |
| `last_progress_updated_at` | DATETIME | Not Null, Default CURRENT_TIMESTAMP      | 进度最后更新时间                         |
| ...通用字段...    |                 |                                            |                                          |
|                   |                 | UK (`user_id`, `course_id`)                | 保证每个学生每门课只有一条进度记录       |

#### 4.3.2 学生作业/测验提交表 (`ana_student_submissions`)

| 字段名          | 类型            | 约束/索引                                  | 说明                                     |
| --------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`            | BIGINT UNSIGNED | PK, AI                                     | 提交ID                                   |
| `user_id`       | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 学生ID                                   |
| `resource_id`   | BIGINT UNSIGNED | FK (res_course_resources.id), Index, Not Null | 作业/测验资源ID (type='quiz' or 'assignment') |
| `submitted_at`  | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 提交时间                                 |
| `submission_content` | TEXT         | Nullable                                   | 提交内容 (文本答案)                      |
| `attachment_url`| VARCHAR(1024)   | Nullable                                   | 附件URL (文件答案)                       |
| `grade`         | DECIMAL(5,2)    | Nullable                                   | 得分                                     |
| `graded_by`     | BIGINT UNSIGNED | FK (usr_users.id), Index, Nullable         | 批改教师ID                               |
| `graded_at`     | DATETIME        | Nullable                                   | 批改时间                                 |
| `feedback`      | TEXT            | Nullable                                   | 教师反馈                                 |
| `status`        | ENUM('submitted', 'grading', 'graded', 'returned') | Not Null, Default 'submitted' | 提交状态                                 |
| ...通用字段...  |                 |                                            |                                          |

#### 4.3.3 学习行为日志表 (`ana_learning_logs`)

| 字段名         | 类型            | 约束/索引                               | 说明                                     |
| -------------- | --------------- | --------------------------------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                  | 日志ID                                   |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null      | 用户ID                                   |
| `action_type`  | VARCHAR(50)     | Not Null                                | 行为类型 (e.g., 'view_resource', 'start_quiz', 'post_comment') |
| `course_id`    | BIGINT UNSIGNED | FK (res_courses.id), Index, Nullable    | 相关课程ID                               |
| `chapter_id`   | BIGINT UNSIGNED | FK (res_course_chapters.id), Index, Nullable | 相关章节ID                               |
| `resource_id`  | BIGINT UNSIGNED | FK (res_course_resources.id), Index, Nullable | 相关资源ID                               |
| `action_timestamp` | DATETIME    | Not Null, Default CURRENT_TIMESTAMP   | 行为发生时间                             |
| `ip_address`   | VARCHAR(45)     | Nullable                                | 用户IP地址                               |
| `user_agent`   | VARCHAR(512)    | Nullable                                | 用户浏览器信息                           |
| `details_json` | JSON            | Nullable                                | 行为详情 (JSON格式，存储额外参数)        |
| ...通用字段... |                 |                                         |                                          |

### 4.4 智能服务模块 (srv_)

#### 4.4.1 知识库问答条目表 (`srv_faq_knowledge_base`) (参考“图书馆咨询助手”)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 条目ID                                   |
| `category`     | VARCHAR(100)    | Index, Nullable | 问题分类 (e.g., '图书馆开放时间', '借阅规则') |
| `question_text`| TEXT            | Not Null       | 标准问题文本                             |
| `answer_text`  | TEXT            | Not Null       | 标准答案文本                             |
| `keywords`     | VARCHAR(512)    | Index (Fulltext), Nullable | 关键词，逗号分隔                         |
| `related_faqs_ids` | JSON        | Nullable       | 相关问题ID列表 (JSON数组 `[id1, id2]`)   |
| `source_document_url` | VARCHAR(1024) | Nullable | 信息来源文档URL                          |
| `is_active`    | BOOLEAN         | Not Null, Default TRUE | 是否启用                                 |
| `hit_count`    | INT UNSIGNED    | Not Null, Default 0 | 被命中次数                               |
| `last_verified_at` | DATETIME    | Nullable       | 最后校验时间                             |
| ...通用字段... |                 |                |                                          |

#### 4.4.2 AI服务调用日志表 (`srv_ai_service_logs`)

| 字段名          | 类型            | 约束/索引                               | 说明                                     |
| --------------- | --------------- | --------------------------------------- | ---------------------------------------- |
| `id`            | BIGINT UNSIGNED | PK, AI                                  | 日志ID                                   |
| `user_id`       | BIGINT UNSIGNED | FK (usr_users.id), Index, Nullable      | 调用用户ID (如果适用)                    |
| `service_name`  | VARCHAR(100)    | Not Null                                | AI服务名称 (e.g., 'CosmicGPT_Library', 'TranslationAPI') |
| `request_payload`| TEXT           | Not Null                                | 请求内容                                 |
| `response_payload`| TEXT          | Nullable                                | 响应内容                                 |
| `status_code`   | INT             | Nullable                                | 服务响应状态码                           |
| `error_message` | TEXT            | Nullable                                | 错误信息 (如果调用失败)                  |
| `processing_time_ms` | INT UNSIGNED | Nullable                               | 处理时长 (毫秒)                          |
| `called_at`     | DATETIME        | Not Null, Default CURRENT_TIMESTAMP   | 调用时间                                 |
| ...通用字段...  |                 |                                         |                                          |

#### 4.4.3 翻译缓存表 (`srv_translations`)

| 字段名           | 类型            | 约束/索引                               | 说明                                     |
| ---------------- | --------------- | --------------------------------------- | ---------------------------------------- |
| `id`             | BIGINT UNSIGNED | PK, AI                                  | 缓存ID                                   |
| `source_language`| VARCHAR(10)     | Not Null                                | 源语言代码 (e.g., 'zh-CN')               |
| `target_language`| VARCHAR(10)     | Not Null                                | 目标语言代码 (e.g., 'en-US')             |
| `source_text_hash`| VARCHAR(64)    | Not Null                                | 源文本的哈希值 (SHA256)                  |
| `source_text`    | TEXT            | Not Null                                | 源文本                                   |
| `translated_text`| TEXT            | Not Null                                | 翻译后的文本                             |
| `provider`       | VARCHAR(50)     | Nullable                                | 翻译服务提供商 (e.g., 'Google', 'Baidu') |
| `cached_at`      | DATETIME        | Not Null, Default CURRENT_TIMESTAMP   | 缓存时间                                 |
| `expires_at`     | DATETIME        | Nullable                                | 缓存过期时间                             |
| ...通用字段...   |                 |                                         |                                          |
|                  |                 | UK (`source_language`, `target_language`, `source_text_hash`) | 保证翻译唯一性                           |

### 4.5 协作与社群模块 (soc_)

#### 4.5.1 论坛/讨论区板块表 (`soc_forums`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 板块ID                                   |
| `forum_name`   | VARCHAR(255)    | UK, Not Null   | 板块名称                                 |
| `description`  | TEXT            | Nullable       | 板块描述                                 |
| `parent_forum_id`| BIGINT UNSIGNED | FK (soc_forums.id), Index, Nullable | 父板块ID (用于层级结构)                  |
| `moderator_ids`| JSON            | Nullable       | 版主用户ID列表 (JSON数组 `[user_id1, user_id2]`) |
| `icon_url`     | VARCHAR(512)    | Nullable       | 板块图标URL                              |
| `post_count`   | INT UNSIGNED    | Not Null, Default 0 | 帖子数量                                 |
| `thread_count` | INT UNSIGNED    | Not Null, Default 0 | 主题数量                                 |
| `is_active`    | BOOLEAN         | Not Null, Default TRUE | 是否激活                                 |
| ...通用字段... |                 |                |                                          |

#### 4.5.2 帖子/主题表 (`soc_threads`)

| 字段名                     | 类型              | 约束/索引                               | 说明                     |
| ----------------------- | --------------- | ----------------------------------- | ---------------------- |
| `id`                    | BIGINT UNSIGNED | PK, AI                              | 主题ID                   |
| `forum_id`              | BIGINT UNSIGNED | FK (soc_forums.id), Index, Not Null | 所属板块ID                 |
| `user_id`               | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null  | 发帖用户ID                 |
| `title`                 | VARCHAR(255)    | Not Null                            | 帖子标题                   |
| `content`               | LONGTEXT        | Not Null                            | 帖子内容 (支持Markdown或HTML) |
| `views_count`           | INT UNSIGNED    | Not Null, Default 0                 | 查看次数                   |
| `replies_count`         | INT UNSIGNED    | Not Null, Default 0                 | 回复数量                   |
| `last_reply_at`         | DATETIME        | Nullable                            | 最后回复时间                 |
| `last_reply_by_user_id` | BIGINT UNSIGNED | FK (usr_users.id), Index, Nullable  | 最后回复用户ID               |
| `is_pinned`             | BOOLEAN         | Not Null, Default FALSE             | 是否置顶                   |
| `is_locked`             | BOOLEAN         | Not Null, Default FALSE             | 是否锁定 (禁止回复)            |
| `tags`                  | VARCHAR(255)    | Nullable                            | 标签 (逗号分隔)              |
| ...通用字段...              |                 |                                     |                        |

#### 4.5.3 回复/评论表 (`soc_posts`)

| 字段名         | 类型            | 约束/索引                               | 说明                                     |
| -------------- | --------------- | --------------------------------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                  | 回复ID                                   |
| `thread_id`    | BIGINT UNSIGNED | FK (soc_threads.id), Index, Not Null    | 所属主题ID                               |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null      | 回复用户ID                               |
| `parent_post_id`| BIGINT UNSIGNED | FK (soc_posts.id), Index, Nullable      | 父回复ID (用于楼中楼)                    |
| `content`      | TEXT            | Not Null                                | 回复内容                                 |
| `upvotes`      | INT UNSIGNED    | Not Null, Default 0                     | 点赞数                                   |
| `downvotes`    | INT UNSIGNED    | Not Null, Default 0                     | 点踩数 (如果需要)                        |
| `is_hidden`    | BOOLEAN         | Not Null, Default FALSE                 | 是否被隐藏 (版主操作)                    |
| ...通用字段... |                 |                                         |                                          |

#### 4.5.4 用户点赞/互动记录表 (`soc_user_interactions`)

| 字段名          | 类型            | 约束/索引                                  | 说明                                     |
| --------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`            | BIGINT UNSIGNED | PK, AI                                     | 记录ID                                   |
| `user_id`       | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 用户ID                                   |
| `target_type`   | ENUM('thread', 'post', 'comment', 'resource') | Not Null | 互动目标类型                             |
| `target_id`     | BIGINT UNSIGNED | Not Null                                   | 互动目标ID                               |
| `interaction_type` | ENUM('like', 'dislike', 'favorite', 'report') | Not Null | 互动类型                                 |
| `created_at`    | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 互动时间                                 |
|                 |                 | UK (`user_id`, `target_type`, `target_id`, `interaction_type`) | 防止重复互动 |

### 4.6 教务服务模块 (edu_)

#### 4.6.1 学期信息表 (`edu_semesters`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 学期ID                                   |
| `semester_name`| VARCHAR(100)    | UK, Not Null   | 学期名称 (e.g., '2023-2024 秋季学期')    |
| `start_date`   | DATE            | Not Null       | 学期开始日期                             |
| `end_date`     | DATE            | Not Null       | 学期结束日期                             |
| `is_current`   | BOOLEAN         | Not Null, Default FALSE, Index | 是否当前学期                             |
| ...通用字段... |                 |                |                                          |

#### 4.6.2 排课计划表 (`edu_course_schedules`)

| 字段名         | 类型            | 约束/索引                                  | 说明                                     |
| -------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 排课ID                                   |
| `course_id`    | BIGINT UNSIGNED | FK (res_courses.id), Index, Not Null       | 课程ID                                   |
| `semester_id`  | BIGINT UNSIGNED | FK (edu_semesters.id), Index, Not Null     | 学期ID                                   |
| `teacher_id`   | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 授课教师ID                               |
| `class_name`   | VARCHAR(100)    | Nullable                                   | 班级名称 (e.g., '计算机科学1班')         |
| `max_capacity` | INT UNSIGNED    | Not Null                                   | 最大选课人数                             |
| `current_enrollment` | INT UNSIGNED | Not Null, Default 0                      | 当前已选人数                             |
| `classroom_id` | BIGINT UNSIGNED | FK (srv_space_resources.id), Index, Nullable | 上课地点ID (关联空间资源表)              |
| `time_slots_json` | JSON          | Not Null                                   | 上课时间段 (JSON数组, e.g., `[{"day_of_week": 1, "start_time": "08:00", "end_time": "09:40", "week_type": "all"}]`, `day_of_week`: 1-7 for Mon-Sun, `week_type`: 'all', 'odd', 'even') |
| `status`       | ENUM('planning', 'open_for_enrollment', 'in_progress', 'finished', 'cancelled') | Not Null, Default 'planning' | 排课状态                                 |
| ...通用字段... |                 |                                            |                                          |

#### 4.6.3 学生选课记录表 (`edu_student_enrollments`)

| 字段名         | 类型            | 约束/索引                                  | 说明                                     |
| -------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 选课记录ID                               |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 学生ID                                   |
| `schedule_id`  | BIGINT UNSIGNED | FK (edu_course_schedules.id), Index, Not Null | 排课ID                                   |
| `enrolled_at`  | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 选课时间                                 |
| `status`       | ENUM('enrolled', 'dropped', 'waitlisted', 'completed', 'failed') | Not Null, Default 'enrolled' | 选课状态                                 |
| `final_grade`  | DECIMAL(5,2)    | Nullable                                   | 最终成绩                                 |
| `grade_points` | DECIMAL(3,2)    | Nullable                                   | 绩点                                     |
| ...通用字段... |                 |                                            |                                          |
|                |                 | UK (`user_id`, `schedule_id`)              | 防止重复选课                             |

#### 4.6.4 考试安排表 (`edu_exam_schedules`)

| 字段名         | 类型            | 约束/索引                                  | 说明                                     |
| -------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 考试安排ID                               |
| `schedule_id`  | BIGINT UNSIGNED | FK (edu_course_schedules.id), Index, Not Null | 关联的课程排课ID                         |
| `exam_type`    | ENUM('midterm', 'final', 'quiz', 'makeup') | Not Null | 考试类型                                 |
| `exam_name`    | VARCHAR(255)    | Not Null                                   | 考试名称                                 |
| `start_time`   | DATETIME        | Not Null                                   | 考试开始时间                             |
| `end_time`     | DATETIME        | Not Null                                   | 考试结束时间                             |
| `location_id`  | BIGINT UNSIGNED | FK (srv_space_resources.id), Index, Nullable | 考试地点ID (关联空间资源表)              |
| `invigilator_ids` | JSON         | Nullable                                   | 监考教师ID列表 (JSON数组 `[user_id1, user_id2]`) |
| `status`       | ENUM('scheduled', 'in_progress', 'completed', 'cancelled') | Not Null, Default 'scheduled' | 考试状态                                 |
| ...通用字段... |                 |                                            |                                          |

#### 4.6.5 学生考试成绩表 (`edu_student_exam_grades`)

| 字段名         | 类型            | 约束/索引                                  | 说明         |
| -------------- | --------------- | ------------------------------------------ | ------------ |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 成绩ID       |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 学生ID       |
| `exam_schedule_id` | BIGINT UNSIGNED | FK (edu_exam_schedules.id), Index, Not Null | 考试安排ID   |
| `score`        | DECIMAL(5,2)    | Nullable                                   | 得分         |
| `comments`     | TEXT            | Nullable                                   | 备注/评语    |
| `recorded_at`  | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 录入时间     |
| ...通用字段... |                 |                                            |              |
|                |                 | UK (`user_id`, `exam_schedule_id`)         | 保证唯一成绩 |

#### 4.6.6 图书借阅记录表 (`edu_book_borrowings`) (参考“借书助手”案例)

| 字段名         | 类型            | 约束/索引                                  | 说明                                     |
| -------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 借阅记录ID                               |
| `user_id`      | BIGINT UNSIGNED | FK (usr_users.id), Index, Not Null         | 借阅用户ID                               |
| `book_id`      | BIGINT UNSIGNED | FK (res_books.id), Index, Not Null         | 借阅图书ID                               |
| `borrowed_at`  | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 借出时间                                 |
| `due_date`     | DATE            | Not Null                                   | 应还日期                                 |
| `returned_at`  | DATETIME        | Nullable                                   | 实际归还时间                             |
| `status`       | ENUM('borrowed', 'returned', 'overdue', 'lost') | Not Null, Default 'borrowed' | 借阅状态                                 |
| `renewal_count`| TINYINT UNSIGNED| Not Null, Default 0                      | 续借次数                                 |
| `fine_amount`  | DECIMAL(10,2)   | Nullable                                   | 罚款金额                                 |
| ...通用字段... |                 |                                            |                                          |

### 4.7 校园服务模块 (srv_)

#### 4.7.1 空间资源表 (`srv_space_resources`) (参考“座位预约”案例)

| 字段名         | 类型            | 约束/索引                                  | 说明                                     |
| -------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI                                     | 空间资源ID                               |
| `space_name`   | VARCHAR(255)    | Not Null                                   | 空间名称 (e.g., '图书馆三楼自习室A区', '会议室301') |
| `space_type`   | VARCHAR(50)     | Not Null, Index                            | 空间类型 (e.g., 'classroom', 'meeting_room', 'study_seat', 'lab') |
| `building_id`  | BIGINT UNSIGNED | FK (srv_map_locations.id), Index, Nullable | 所在建筑ID (关联地图位置表)              |
| `floor`        | VARCHAR(20)     | Nullable                                   | 楼层                                     |
| `capacity`     | INT UNSIGNED    | Nullable                                   | 容量 (e.g., 座位数, 会议室容纳人数)      |
| `description`  | TEXT            | Nullable                                   | 空间描述                                 |
| `image_url`    | VARCHAR(512)    | Nullable                                   | 空间图片URL                              |
| `is_reservable`| BOOLEAN         | Not Null, Default TRUE                     | 是否可预约                               |
| `status`       | ENUM('available', 'unavailable', 'maintenance') | Not Null, Default 'available' | 空间状态                                 |
| `attributes_json`| JSON          | Nullable                                   | 额外属性 (e.g., `{"has_projector": true, "has_wifi": true}`) |
| ...通用字段... |                 |                                            |                                          |

#### 4.7.2 空间预约记录表 (`srv_space_bookings`) (参考“座位预约”案例)

| 字段名             | 类型                                                                         | 约束/索引                                        | 说明           |
| --------------- | -------------------------------------------------------------------------- | -------------------------------------------- | ------------ |
| `id`            | BIGINT UNSIGNED                                                            | PK, AI                                       | 预约ID         |
| `user_id`       | BIGINT UNSIGNED                                                            | FK (usr_users.id), Index, Not Null           | 预约用户ID       |
| `space_id`      | BIGINT UNSIGNED                                                            | FK (srv_space_resources.id), Index, Not Null | 预约空间ID       |
| `start_time`    | DATETIME                                                                   | Not Null                                     | 预约开始时间       |
| `end_time`      | DATETIME                                                                   | Not Null                                     | 预约结束时间       |
| `purpose`       | VARCHAR(255)                                                               | Nullable                                     | 预约用途         |
| `status`        | ENUM('pending_approval', 'confirmed', 'cancelled', 'completed', 'no_show') | Not Null, Default 'confirmed'                | 预约状态         |
| `booking_code`  | VARCHAR(50)                                                                | UK, Nullable                                 | 预约凭证码 (用于签到) |
| `checked_in_at` | DATETIME                                                                   | Nullable                                     | 签到时间         |
| ...通用字段...      |                                                                            |                                              |              |
|                 |                                                                            | Index (`space_id`, `start_time`, `end_time`) | 用于冲突检测       |

#### 4.7.3 地图位置信息表 (`srv_map_locations`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 位置ID                                   |
| `location_name`| VARCHAR(255)    | Not Null       | 位置名称 (e.g., '图书馆', '第一教学楼')   |
| `location_type`| VARCHAR(50)     | Not Null, Index | 位置类型 (e.g., 'building', 'landmark', 'service_point') |
| `latitude`     | DECIMAL(10, 8)  | Not Null       | 纬度                                     |
| `longitude`    | DECIMAL(11, 8)  | Not Null       | 经度                                     |
| `altitude`     | DECIMAL(10, 2)  | Nullable       | 海拔高度 (如果需要)                      |
| `description`  | TEXT            | Nullable       | 位置描述                                 |
| `icon_url`     | VARCHAR(512)    | Nullable       | 地图图标URL                              |
| `parent_location_id` | BIGINT UNSIGNED | FK (srv_map_locations.id), Index, Nullable | 父位置ID (用于区域划分)                  |
| ...通用字段... |                 |                |                                          |

#### 4.7.4 导航路径缓存表 (`srv_navigation_route_cache`)

| 字段名           | 类型            | 约束/索引                                  | 说明                                     |
| ---------------- | --------------- | ------------------------------------------ | ---------------------------------------- |
| `id`             | BIGINT UNSIGNED | PK, AI                                     | 缓存ID                                   |
| `start_location_id`| BIGINT UNSIGNED | FK (srv_map_locations.id), Not Null      | 起点位置ID                               |
| `end_location_id`| BIGINT UNSIGNED | FK (srv_map_locations.id), Not Null      | 终点位置ID                               |
| `route_data_json`| JSON            | Not Null                                   | 路径数据 (JSON格式，包含点序列、导航指令等) |
| `travel_mode`    | VARCHAR(50)     | Not Null                                   | 出行方式 (e.g., 'walking', 'cycling')    |
| `distance_meters`| INT UNSIGNED    | Nullable                                   | 路径长度 (米)                            |
| `duration_seconds`| INT UNSIGNED   | Nullable                                   | 预计时长 (秒)                            |
| `cached_at`      | DATETIME        | Not Null, Default CURRENT_TIMESTAMP      | 缓存时间                                 |
| `expires_at`     | DATETIME        | Nullable                                   | 缓存过期时间                             |
| ...通用字段...   |                 |                                            |                                          |
|                  |                 | UK (`start_location_id`, `end_location_id`, `travel_mode`) | 保证路径唯一性 |

### 4.8 系统配置与日志模块 (sys_)

#### 4.8.1 系统配置表 (`sys_configurations`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | INT UNSIGNED    | PK, AI         | 配置ID                                   |
| `config_key`   | VARCHAR(100)    | UK, Not Null   | 配置键                                   |
| `config_value` | TEXT            | Not Null       | 配置值                                   |
| `description`  | VARCHAR(255)    | Nullable       | 配置描述                                 |
| `is_encrypted` | BOOLEAN         | Not Null, Default FALSE | 值是否加密存储                           |
| ...通用字段... |                 |                |                                          |

#### 4.8.2 消息队列任务表 (`sys_mq_tasks`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 任务ID                                   |
| `queue_name`   | VARCHAR(100)    | Not Null, Index | 队列名称                                 |
| `payload`      | LONGTEXT        | Not Null       | 消息内容                                 |
| `status`       | ENUM('pending', 'processing', 'completed', 'failed', 'retrying') | Not Null, Default 'pending', Index | 任务状态 |
| `attempts`     | TINYINT UNSIGNED| Not Null, Default 0 | 已尝试次数                               |
| `max_attempts` | TINYINT UNSIGNED| Not Null, Default 3 | 最大尝试次数                             |
| `last_error`   | TEXT            | Nullable       | 最后一次错误信息                         |
| `available_at` | DATETIME        | Not Null, Default CURRENT_TIMESTAMP, Index | 任务可执行时间 (用于延迟任务)          |
| `processed_at` | DATETIME        | Nullable       | 任务处理完成时间                         |
| ...通用字段... |                 |                |                                          |

#### 4.8.3 调度计划日志表 (`sys_scheduler_logs`)

| 字段名         | 类型            | 约束/索引      | 说明                                     |
| -------------- | --------------- | -------------- | ---------------------------------------- |
| `id`           | BIGINT UNSIGNED | PK, AI         | 日志ID                                   |
| `job_name`     | VARCHAR(255)    | Not Null, Index | 调度任务名称                             |
| `start_time`   | DATETIME        | Not Null       | 任务开始时间                             |
| `end_time`     | DATETIME        | Nullable       | 任务结束时间                             |
| `status`       | ENUM('success', 'failure', 'running') | Not Null | 执行状态                                 |
| `output`       | LONGTEXT        | Nullable       | 任务输出/日志信息                        |
| ...通用字段... |                 |                |                                          |

## 5. 关键设计说明

*   **动态权限隔离**：通过 `usr_users`, `usr_roles`, `usr_permissions`, `usr_user_roles`, `usr_role_permissions` 表实现基于角色的访问控制 (RBAC)。权限可以细化到资源类型和具体操作。
*   **JSON数据类型的使用**：
    *   `edu_course_schedules.time_slots_json`: 存储灵活的上课时间安排，便于前端解析和后端冲突检测。
    *   `srv_space_resources.attributes_json`: 存储空间的动态属性，方便扩展。
    *   `srv_faq_knowledge_base.related_faqs_ids`: 存储相关问题的ID列表。
    *   `soc_forums.moderator_ids`, `edu_exam_schedules.invigilator_ids`: 存储用户ID列表。
    *   **验证**：应用层需要对JSON结构和内容进行验证，确保数据一致性。
*   **索引优化**：
    *   在所有外键字段上创建索引。
    *   在经常用于查询条件的字段上创建索引 (e.g., `username`, `email`, `course_code`, `status` 等)。
    *   对于组合查询频繁的字段，考虑创建联合索引 (e.g., `srv_space_bookings` 的 `space_id, start_time, end_time` 用于冲突检测)。
    *   `srv_faq_knowledge_base.keywords` 使用全文索引 (Fulltext Index) 以支持高效的关键词搜索。
*   **软删除**：所有主要业务表均包含 `deleted_at` 字段，实现软删除，方便数据恢复和审计。
*   **时间处理**：所有时间字段统一使用 `DATETIME` 类型，并存储UTC时间，应用层根据用户时区进行转换显示。
*   **枚举类型 (ENUM)**：用于状态字段等固定选项的字段，提高数据一致性和可读性。应用层需要有相应的映射关系。
*   **教学案例集成**：
    *   **借书助手**：体现在 `res_books`, `res_book_categories`, `edu_book_borrowings` 表的设计中，支持图书信息管理和借阅流程。
    *   **座位预约/作业布置中的空间管理**：体现在 `srv_space_resources` 和 `srv_space_bookings` 表的设计中，支持各类校园空间的管理和预约。
    *   **图书馆咨询助手**：体现在 `srv_faq_knowledge_base` 表的设计中，用于存储和管理问答知识。
*   **数据字典**：建议维护一个数据字典，详细说明每个表、每个字段的含义、取值范围、业务规则等，方便开发和维护。
*   **冲突检测逻辑**：
    *   **排课冲突**：在 `edu_course_schedules` 表中，通过 `teacher_id`, `classroom_id` 和 `time_slots_json` 进行检测。需要复杂的逻辑来解析 `time_slots_json` 并比较时间段重叠。
    *   **空间预约冲突**：在 `srv_space_bookings` 表中，通过 `space_id`, `start_time`, `end_time` 进行检测。查询 `NOT (new_end_time <= existing_start_time OR new_start_time >= existing_end_time)` 来判断重叠。
*   **多语言支持**：
    *   `usr_users.language_preference` 存储用户语言偏好。
    *   `srv_translations` 表用于缓存常用文本的翻译结果，减少对翻译API的调用频率。
    *   对于需要国际化的内容（如课程名称、描述等），可以考虑以下方案：
        1.  **分离翻译表**：为每个需要翻译的实体创建一个对应的翻译表，如 `res_courses_translations (course_id, language_code, course_name, description)`。查询时JOIN。
        2.  **JSON存储**：在原表中增加一个JSON字段存储多语言版本，如 `res_courses.name_translations = {"en-US": "English Name", "zh-CN": "中文名称"}`。查询时解析JSON。
        方案1结构更清晰，查询性能可能更好；方案2更灵活，但查询和索引较复杂。当前设计暂未完全实现字段级多语言，可根据实际需求选择方案扩展。

## 6. 待进一步明确的设计点

*   **知识图谱防环**：如果教学资源模块未来要构建复杂的知识图谱（如课程先后修关系），需要设计机制防止循环依赖。可以在关联表中增加路径记录或在插入/更新时进行检测。
*   **文件存储策略**：`res_course_resources.file_path` 和 `res_course_resources.resource_url` 需要明确具体的文件存储方案（本地服务器、对象存储服务如S3/OSS等）。
*   **实时消息通知**：如选课成功、考试安排变更、预约确认等，需要结合消息队列 (`sys_mq_tasks`) 和可能的WebSocket服务进行设计。
*   **数据分析与可视化**：轻分析平台的数据源将是这些数据库表。需要根据具体的分析需求，设计合适的数据抽取、转换和加载 (ETL) 过程，或者直接连接数据库进行分析。
