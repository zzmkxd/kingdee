# 第二章作业布置

## 任务一：借书功能设计

### 任务说明

书籍大全列表中，新增操作列，操作类型中，新增一个**空操作**，并改名为**“借阅”**。添加成功之后，注册列表插件，继承**AbstractListPlugin**类，实现**afterDoOperation**方法，监听空操作按钮，弹出到**借书单据**，传递相关参数，在借书单据中进行书籍借阅，实现逻辑。

![1-操作列](.\picture\1-操作列.png)

### 借书按钮代码示例

```java
public class CourseBorrowBook extends AbstractListPlugin implements Plugin {
    @Override
    public void afterDoOperation(AfterDoOperationEventArgs args) {
        super.afterDoOperation(args);
        if ("donothing".equals(args.getOperateKey())) {
            IListView listview = (IListView)this.getView();
            long rowPkId = (long) listview.getFocusRowPkId();
            //设置BillShowParameter
            DynamicObject bookSingle = BusinessDataServiceHelper.loadSingle("ozwe_book", new QFilter[]{new QFilter("id", QCP.equals, rowPkId)});
            if (!bookSingle.getString("ozwe_combo").equalsIgnoreCase("0")) {
                this.getView().showMessage("该书籍已被借阅");
                return;
            }
            BillShowParameter billShowParameter = new BillShowParameter();
            billShowParameter.setFormId("ozwe_borrow");
            //设置宽高
            StyleCss styleCss = new StyleCss();
            styleCss.setHeight("600");
            styleCss.setWidth("1200");
            billShowParameter.getOpenStyle().setInlineStyleCss(styleCss);
            billShowParameter.getOpenStyle().setShowType(ShowType.Modal);
            //传递参数
            billShowParameter.setCustomParam("bookBaseInfo", rowPkId);
            //show出新表单
            this.getView().showForm(billShowParameter);
        }
    }
}
```

## 任务二：借书单据接受参数并执行借阅操作

### 任务说明

在打开了借书单据之后，我们需要在该表单内接受传递的参数，并且要将其呈现在单据中，如下图所示。当用户填写完成之后，点击借阅按钮，可以执行**提交操作**，成功借阅，并且带动**书籍大全基础资料**，将该书籍设置为**借阅中**状态。

![zy-2-借书](.\picture\zy-2-借书.png)

![zy-2-借阅成功](.\picture\zy-2-借阅成功.png)



### 代码示例

```java
public class BorrowBook extends AbstractBillPlugIn {

    /*
    * 关闭页面忽略参数变化
    **/
    @Override
    public void beforeClosed(BeforeClosedEvent e) {
        super.beforeClosed(e);
        e.setCheckDataChange(false);
    }

    @Override
    public void registerListener(EventObject e) {
        this.addItemClickListeners("tbmain");
    }

    @Override
    public void beforeBindData(EventObject event) {
        //接受传递参数
        long pkValue = this.getView().getFormShowParameter().getCustomParam("bookBaseInfo");
        this.getModel().setValue("ozwe_booklist", pkValue);
    }

    @Override
    public void afterCreateNewData(EventObject eventObject) {
        //随机生成单据编码
        long billNo = (long) (Math.random()*Math.pow(10,15));
        this.getModel().setValue("billNo", billNo);
    }

    @Override
    public void itemClick(ItemClickEvent ee) {
        if ("ozwe_borrow_btn".equalsIgnoreCase(ee.getItemKey())) {
            long pkValue = this.getView().getFormShowParameter().getCustomParam("bookBaseInfo");
            int day = (int) this.getModel().getValue("ozwe_day");
            if (day <= 0) {
                this.getView().showMessage("请正确填写借阅天数");
                return;
            }
            //执行提交操作
            OperationResult submit = OperationServiceHelper.executeOperate("submit", "ozwe_borrow", new DynamicObject[]{this.getModel().getDataEntity()}, OperateOption.create());
            this.getView().showMessage("借阅成功");
            this.getView().close();
            //获取书籍基础资料，更新借阅状态
            DynamicObject bookSingle = BusinessDataServiceHelper.loadSingle("ozwe_book", new QFilter[]{new QFilter("id", QCP.equals, pkValue)});
            bookSingle.set("ozwe_combo", "1");
            SaveServiceHelper.saveOperate("ozwe_book", new DynamicObject[] {bookSingle}, null);
        }
    }
}
```

## 任务三：还书功能设计

### 任务说明

在**书籍借阅列表**中，新增**操作列**，设置还书按钮，点击按钮之后，将该单据的归还状态设置为**已归还**，并且将书籍大全中的书籍状态更改为可借阅。

![zy-2-归还成功](.\picture\zy-2-归还成功.png)

### 代码示例

~~~java
public class ReturnBook1 extends AbstractListPlugin {
    @Override
    public void afterDoOperation(AfterDoOperationEventArgs args) {
        super.afterDoOperation(args);
        if ("donothing".equals(args.getOperateKey())) {
            IListView listview = (IListView)this.getView();
            long rowPkId = (long) listview.getFocusRowPkId();
            DynamicObject bookBorrowObject = BusinessDataServiceHelper.loadSingle("ozwe_borrow", new QFilter[]{new QFilter("id", QCP.equals, rowPkId)});
            if (bookBorrowObject.getString("ozwe_combo_return").equalsIgnoreCase("1")) {
                this.getView().showMessage("该书籍已归还");
                return;
            }
            //更改借阅状态
            bookBorrowObject.set("ozwe_combo_return", "1");
            SaveServiceHelper.saveOperate("ozwe_borrow", new DynamicObject[] {bookBorrowObject}, null);
            //书籍大全更改书籍状态
            DynamicObject bookListObject = bookBorrowObject.getDynamicObject("ozwe_booklist");
            bookListObject.set("ozwe_combo", "0");
            SaveServiceHelper.saveOperate("ozwe_book", new DynamicObject[] {bookListObject}, null);
            this.getView().showMessage("归还成功");
        }
    }
}
~~~

